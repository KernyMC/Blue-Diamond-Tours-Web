---
import { Icon } from "astro-icon/components";
import Button from "../common/Button.astro";
import ContactFormModal from "../common/ContactFormModal.astro";

interface NavLink {
    name: string;
    path: string;
}

const navLinks: NavLink[] = [
    { name: "Inicio", path: "/" },
    { name: "Nosotros", path: "/nosotros" },
    { name: "Tours", path: "/tours" },
    { name: "Paquetes", path: "/paquetes" },
    { name: "Ferries", path: "/ferries" },
    { name: "Contacto", path: "/contacto" },
];

const currentPath = Astro.url.pathname;
const isActive = (path: string): boolean =>
    currentPath === path || (path !== "/" && currentPath.startsWith(path));
---

<nav
    id="main-nav"
    class="fixed w-[95%] md:w-[85%] max-w-6xl top-6 left-1/2 -translate-x-1/2 z-50 bg-white/95 backdrop-blur-md shadow-2xl rounded-full flex justify-between items-center px-6 md:px-8 py-3 transition-all duration-500 ease-in-out border border-gray-100/50 scale-100"
>
    {/* Logo Section */}
    <a
        href="/"
        class="flex items-center gap-3 cursor-pointer no-underline group"
    >
        <div>
            <img
                src="/blue-diamond-logo-navbar.svg"
                alt="Blue Diamond Logo"
                width={64}
                height={24}
            />
        </div>
        <div>
            <div class="flex flex-col">
                <span
                    class="uppercase font-sans text-xl md:text-2xl font-bold text-navy leading-none tracking-tight text-center"
                >
                    Gal치pagos
                </span>
                <span
                    class="uppercase font-sans text-[0.65rem] md:text-xs font-bold text-navy tracking-[0.1em]"
                >
                    Bluediamond Tours
                </span>
            </div>
        </div>
    </a>

    {/* Desktop Menu */}
    <div class="hidden md:flex items-center gap-8">
        {
            navLinks.map((link) => (
                <a
                    href={link.path}
                    class={`text-sm font-bold tracking-wide transition-all duration-300 relative group no-underline
          ${isActive(link.path) ? "text-turquoise" : "text-navy hover:text-turquoise"}
        `}
                >
                    {link.name}
                    <span
                        class={`absolute -bottom-1 left-0 h-0.5 bg-turquoise transition-all duration-300 ${isActive(link.path) ? "w-full" : "w-0 group-hover:w-full"}`}
                    />
                </a>
            ))
        }

        {/* Language Selector */}
        <div class="relative language-selector">
            <button
                id="language-btn"
                class="flex items-center gap-2 text-navy hover:text-turquoise transition-all duration-300 cursor-pointer bg-transparent border-none text-sm font-bold"
            >
                <Icon name="ant-design:alipay-outlined" class="w-5 h-5" />
                <span id="current-lang">ES</span>
                <Icon
                    name="ant-design:down-outlined"
                    class="w-4 h-4 transition-transform duration-300"
                    id="lang-chevron"
                />
            </button>

            <div
                id="language-dropdown"
                class="absolute top-full right-0 mt-2 bg-white rounded-2xl shadow-2xl border border-gray-100/50 overflow-hidden opacity-0 invisible transition-all duration-300 min-w-[140px]"
            >
                <button
                    onclick="changeLanguage('es', 'ES')"
                    class="w-full px-4 py-3 text-left text-sm font-bold text-navy hover:bg-turquoise/10 hover:text-turquoise transition-all cursor-pointer bg-transparent border-none flex items-center gap-2"
                >
                    <span class="text-lg">游쀯릖</span>
                    Espa침ol
                </button>
                <button
                    onclick="changeLanguage('en', 'EN')"
                    class="w-full px-4 py-3 text-left text-sm font-bold text-navy hover:bg-turquoise/10 hover:text-turquoise transition-all cursor-pointer bg-transparent border-none flex items-center gap-2"
                >
                    <span class="text-lg">游섫릖</span>
                    English
                </button>
                <button
                    onclick="changeLanguage('fr', 'FR')"
                    class="w-full px-4 py-3 text-left text-sm font-bold text-navy hover:bg-turquoise/10 hover:text-turquoise transition-all cursor-pointer bg-transparent border-none flex items-center gap-2"
                >
                    <span class="text-lg">游游</span>
                    Fran칞ais
                </button>
            </div>
        </div>

        <button
            onclick="openContactModal()"
            class="bg-turquoise text-white py-2.5 px-6 rounded-full text-sm font-bold shadow-lg hover:shadow-turquoise/30 hover:bg-[#1F5F99] transition-all cursor-pointer border-none"
        >
            Reserva Ya
        </button>
    </div>

    {/* Mobile Menu Button */}
    <button id="mobile-menu-btn" class="md:hidden text-navy cursor-pointer">
        <div id="menu-icon">
            <Icon name="ant-design:menu-outlined" />
        </div>
        <div id="close-icon" class="hidden">
            <Icon name="ant-design:close-outlined" />
        </div>
    </button>
</nav>

{/* Mobile Menu Overlay */}
<div
    id="mobile-menu"
    class="fixed inset-0 bg-white/95 backdrop-blur-xl z-40 transform translate-y-full transition-transform duration-500 md:hidden flex flex-col items-center justify-center gap-8"
>
    {
        navLinks.map((link) => (
            <a
                href={link.path}
                class={`text-2xl font-serif font-bold ${isActive(link.path) ? "text-turquoise" : "text-navy"} mobile-link`}
            >
                {link.name}
            </a>
        ))
    }

    {/* Mobile Language Selector */}
    <div class="flex gap-4 mt-4">
        <button
            onclick="changeLanguage('es', 'ES')"
            class="px-6 py-3 rounded-full border-2 border-navy text-navy font-bold hover:bg-navy hover:text-white transition-all cursor-pointer bg-transparent text-base"
        >
            游쀯릖 ES
        </button>
        <button
            onclick="changeLanguage('en', 'EN')"
            class="px-6 py-3 rounded-full border-2 border-navy text-navy font-bold hover:bg-navy hover:text-white transition-all cursor-pointer bg-transparent text-base"
        >
            游섫릖 EN
        </button>
        <button
            onclick="changeLanguage('fr', 'FR')"
            class="px-6 py-3 rounded-full border-2 border-navy text-navy font-bold hover:bg-navy hover:text-white transition-all cursor-pointer bg-transparent text-base"
        >
            游游 FR
        </button>
    </div>

    <a href="/contacto" class="no-underline mt-4">
        <Button
            variant="primary"
            className="py-4 px-10 text-lg rounded-full shadow-xl"
        >
            Reserva Tu Aventura
        </Button>
    </a>
</div>

<script type="text/javascript" is:inline>
    function googleTranslateElementInit() {
        new google.translate.TranslateElement(
            {
                pageLanguage: "es",
                includedLanguages: "es,en,fr",
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
            },
            "google_translate_element",
        );
    }
</script>

<script
    type="text/javascript"
    src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    is:inline></script>

<script is:inline>
    // Change language function
    window.changeLanguage = function (langCode, langDisplay) {
        const currentLangEl = document.getElementById("current-lang");
        if (currentLangEl) {
            currentLangEl.textContent = langDisplay;
        }

        // Close dropdown
        const dropdown = document.getElementById("language-dropdown");
        if (dropdown) {
            dropdown.classList.remove("opacity-100", "visible");
            dropdown.classList.add("opacity-0", "invisible");
        }

        // Function to trigger translation
        function triggerTranslation() {
            const selectElement = document.querySelector(".goog-te-combo");
            if (selectElement) {
                selectElement.value = langCode;
                selectElement.dispatchEvent(new Event("change"));
                return true;
            }
            return false;
        }

        // Try to trigger translation immediately
        if (!triggerTranslation()) {
            // If not ready, wait and retry
            let attempts = 0;
            const maxAttempts = 30;
            const checkInterval = setInterval(() => {
                attempts++;
                if (triggerTranslation() || attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                }
            }, 100);
        }
    };
</script>

<script>
    // Language dropdown toggle
    const languageBtn = document.getElementById("language-btn");
    const languageDropdown = document.getElementById("language-dropdown");
    const langChevron = document.getElementById("lang-chevron");

    if (languageBtn && languageDropdown) {
        languageBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const isVisible =
                languageDropdown.classList.contains("opacity-100");

            if (isVisible) {
                languageDropdown.classList.remove("opacity-100", "visible");
                languageDropdown.classList.add("opacity-0", "invisible");
                langChevron?.classList.remove("rotate-180");
            } else {
                languageDropdown.classList.remove("opacity-0", "invisible");
                languageDropdown.classList.add("opacity-100", "visible");
                langChevron?.classList.add("rotate-180");
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", () => {
            languageDropdown.classList.remove("opacity-100", "visible");
            languageDropdown.classList.add("opacity-0", "invisible");
            langChevron?.classList.remove("rotate-180");
        });
    }

    // Navbar Scroll Effect (solo en m칩vil)
    const nav = document.getElementById("main-nav");

    if (nav) {
        window.addEventListener("scroll", () => {
            // Solo aplicar el efecto en pantallas menores a 768px (m칩viles)
            if (window.innerWidth < 768) {
                if (window.scrollY > 50) {
                    nav.classList.add("w-[92%]", "max-w-5xl", "scale-95");
                    nav.classList.remove("w-[95%]", "max-w-6xl", "scale-100");
                } else {
                    nav.classList.remove("w-[92%]", "max-w-5xl", "scale-95");
                    nav.classList.add("w-[95%]", "max-w-6xl", "scale-100");
                }
            }
        });
    }

    // Mobile Menu Toggle
    const menuBtn = document.getElementById("mobile-menu-btn");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuIcon = document.getElementById("menu-icon");
    const closeIcon = document.getElementById("close-icon");
    const mobileLinks = document.querySelectorAll(".mobile-link");
    let isMenuOpen = false;

    function toggleMenu(): void {
        if (!mobileMenu || !menuIcon || !closeIcon) return;

        if (isMenuOpen) {
            mobileMenu.classList.remove("translate-y-full");
            menuIcon.classList.add("hidden");
            closeIcon.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        } else {
            mobileMenu.classList.add("translate-y-full");
            menuIcon.classList.remove("hidden");
            closeIcon.classList.add("hidden");
            document.body.style.overflow = "";
        }
    }

    if (menuBtn) {
        menuBtn.addEventListener("click", () => {
            isMenuOpen = !isMenuOpen;
            toggleMenu();
        });
    }

    mobileLinks.forEach((link) => {
        link.addEventListener("click", () => {
            isMenuOpen = false;
            toggleMenu();
        });
    });
</script>

<!-- Hidden Google Translate Element -->
<div id="google_translate_element" style="display: none;"></div>

<!-- Contact Form Modal -->
<ContactFormModal />

<style is:global>
    /* Hide Google Translate default UI */
    .goog-te-banner-frame,
    .goog-te-balloon-frame,
    .skiptranslate iframe {
        display: none !important;
    }

    body {
        top: 0 !important;
    }

    .goog-te-gadget {
        display: none !important;
    }

    /* Prevent Google Translate from adding top margin */
    body.translated-ltr {
        margin-top: 0 !important;
    }
</style>
